<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>MetaQuestVR (web)</title>
<style>
:root{ --clock-color: #66f8ff; --ui-bg: rgba(0,0,0,0.45); --ui-accent: #29a3ff; }
html,body{height:100%;margin:0;background:#000;overflow:hidden;-webkit-user-select:none;user-select:none}
body.landscape{ transform-origin:center center; transform: rotate(90deg) translateY(-100vh); width:100vh; height:100vw; overflow:hidden; position:fixed; left:0; top:0}
#cameraVideo{position:fixed; inset:0; width:100vw; height:100vh; object-fit:cover; z-index:0; transform: none; -webkit-transform: none; background:#000}
#clock{position:fixed; right:14px; bottom:14px; z-index:2000; color:var(--clock-color); font-weight:700; font-family:system-ui, -apple-system, "Helvetica Neue", "Segoe UI"; font-size:18px; text-shadow:0 2px 6px rgba(0,0,0,0.6)}
#hudButtons{position:fixed; left:14px; top:14px; z-index:2000; display:flex; gap:8px; align-items:center}
.btn{background:var(--ui-bg); color:#fff; border-radius:10px; padding:8px; min-width:40px; text-align:center; font-weight:600; box-shadow:0 6px 18px rgba(0,0,0,0.6)}
.iconBtn{width:42px; height:42px; display:flex; align-items:center; justify-content:center; border-radius:10px; font-size:18px}
#settingsPanel{position:fixed; left:14px; top:64px; z-index:2000; background:rgba(6,6,6,0.6); color:#fff; padding:10px; border-radius:10px; width:220px; display:none; font-family:system-ui}
#settingsPanel label{display:flex; justify-content:space-between; margin:6px 0; align-items:center}
#settingsPanel input[type=range]{width:100%}
#gpCursor{position:fixed; width:22px; height:22px; border-radius:50%; background:rgba(255,255,255,0.95); transform:translate(-50%,-50%); z-index:1500; pointer-events:none; box-shadow:0 6px 18px rgba(0,0,0,0.5)}
#threeContainer{position:fixed; inset:0; z-index:100; pointer-events:none}
.app-window{width:360px; height:220px; border-radius:10px; overflow:hidden; background:rgba(18,18,24,0.88); box-shadow:0 14px 40px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.04); transform-style:preserve-3d; cursor:grab; pointer-events:auto}
.titlebar{height:34px; display:flex; align-items:center; padding:0 10px; gap:8px; background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(0,0,0,0.2)); color:#fff; font-weight:700; font-size:14px}
.title-actions{margin-left:auto; display:flex; gap:6px}
.tbtn{width:30px;height:26px;border-radius:6px;display:flex;align-items:center;justify-content:center;background:transparent;color:#fff; border:1px solid rgba(255,255,255,0.03); cursor:pointer}
.app-iframe{width:100%; height:calc(100% - 34px); border:none; background:#fff}
#addBtn{position:fixed; left:14px; bottom:14px; z-index:2000}
#hint{position:fixed; top:14px; right:14px; color:#ddd; z-index:2000; font-size:13px}
@media (max-width:600px){ .app-window{width:300px;height:200px} }
</style>
</head>
<body>
<video id="cameraVideo" autoplay playsinline muted></video>
<div id="threeContainer"></div>
<div id="gpCursor" style="display:none"></div>
<div id="clock" aria-hidden="false"></div>
<div id="hudButtons">
  <div id="gearBtn" class="btn iconBtn" title="Ë®≠ÂÆö">‚öô</div>
  <div id="addBtnUI" class="btn" title="„Ç¶„Ç£„É≥„Éâ„Ç¶ËøΩÂä†">Ôºã</div>
</div>
<div id="settingsPanel">
  <div style="font-weight:800;margin-bottom:6px">Ë®≠ÂÆö</div>
  <label>ÊôÇË®àË°®Á§∫ <input id="clockToggle" type="checkbox" checked></label>
  <label>ÊôÇË®àËâ≤ <input id="clockColor" type="color" value="#66f8ff"></label>
  <label>„Ç¶„Ç£„É≥„Éâ„Ç¶ÈÄèÊòéÂ∫¶ <input id="wndAlpha" type="range" min="20" max="100" value="88"></label>
  <label>„Ç¶„Ç£„É≥„Éâ„Ç¶„Ç∑„É£„Éâ„Ç¶ <input id="shadowToggle" type="checkbox" checked></label>
  <div style="display:flex;gap:6px;margin-top:8px">
    <button id="addWindowBtn" class="btn" style="flex:1">Ôºã „Ç¶„Ç£„É≥„Éâ„Ç¶</button>
    <button id="resetBtn" class="btn" style="flex:1">ÂàùÊúüÂåñ</button>
  </div>
</div>
<div id="hint">Controller: L-stick move ‚Üí show cursor. A/X mapped to buttons.</div>
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.155.0/examples/js/renderers/CSS3DRenderer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"></script>
<script src="js/hand.js"></script>
<script>
(async function main(){
  try{ if(screen.orientation && screen.orientation.lock) await screen.orientation.lock('landscape') }catch(e){}
  function applyLandscapeClass(){ if(window.innerHeight > window.innerWidth){ document.body.classList.add('landscape') } else { document.body.classList.remove('landscape') } }
  applyLandscapeClass(); window.addEventListener('resize', applyLandscapeClass);
  const video = document.getElementById('cameraVideo');
  async function startCam(){
    try{ const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode: { exact:"environment" } }, audio:false }); video.srcObject = s }catch(_){
      try{ const s = await navigator.mediaDevices.getUserMedia({ video:{ facingMode: "environment" }, audio:false }); video.srcObject = s }catch(err){ console.warn('camera failed', err) }
    }
  }
  startCam();
  const clockEl = document.getElementById('clock');
  const clockToggle = document.getElementById('clockToggle');
  const clockColorInput = document.getElementById('clockColor');
  function fmt2(n){ return n<10?('0'+n):n }
  function updateClock(){ const d = new Date(); clockEl.textContent = `${d.getHours()}ÊôÇ:${fmt2(d.getMinutes())}` }
  updateClock(); setInterval(updateClock, 1000);
  clockToggle.addEventListener('change', ()=>{ clockEl.style.display = clockToggle.checked ? 'block' : 'none' });
  clockColorInput.addEventListener('input', ()=>{ clockEl.style.color = clockColorInput.value });
  const threeContainer = document.getElementById('threeContainer');
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 1, 10000);
  camera.position.set(0,0,800);
  const renderer = new THREE.CSS3DRenderer();
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.domElement.style.pointerEvents = 'none';
  threeContainer.appendChild(renderer.domElement);
  window.addEventListener('resize', ()=>{ camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight) });
  const cssObjects = [];
  const stateKey = 'mqvr_windows_v1';
  function makeWindowElement(data){
    const wrapper = document.createElement('div');
    wrapper.className = 'app-window';
    wrapper.style.opacity = (data.alpha||0.88);
    wrapper.style.background = `rgba(18,18,24,${(data.alpha||0.88)})`;
    wrapper.style.width = (data.w||360)+'px';
    wrapper.style.height = (data.h||220)+'px';
    const title = document.createElement('div');
    title.className = 'titlebar';
    title.innerHTML = `<div class="titleText">${data.title||'App'}</div>`;
    const actions = document.createElement('div');
    actions.className = 'title-actions';
    const close = document.createElement('button'); close.className='tbtn'; close.innerHTML='‚úï';
    const grab = document.createElement('button'); grab.className='tbtn'; grab.innerHTML='‚úã';
    const urlBtn = document.createElement('button'); urlBtn.className='tbtn'; urlBtn.innerHTML='üåê';
    actions.appendChild(urlBtn); actions.appendChild(grab); actions.appendChild(close);
    title.appendChild(actions);
    wrapper.appendChild(title);
    const iframe = document.createElement('iframe');
    iframe.className = 'app-iframe';
    iframe.src = data.url || 'https://www.youtube.com';
    wrapper.appendChild(iframe);
    let dragging=false, lastPointer=null, vel={x:0,y:0};
    title.addEventListener('pointerdown', (ev)=>{ ev.preventDefault(); dragging=true; lastPointer = {x:ev.clientX,y:ev.clientY, t:performance.now()}; wrapper.style.cursor='grabbing'; if(elRef && elRef.position) elRef.position.z = -50 });
    window.addEventListener('pointermove', (ev)=>{ if(!dragging) return; const now = performance.now(); const dx = ev.clientX - lastPointer.x; const dy = ev.clientY - lastPointer.y; const dt = Math.max(1, now - lastPointer.t); vel.x = dx/dt*16; vel.y = dy/dt*16; lastPointer = {x:ev.clientX,y:ev.clientY,t:now}; if(elRef){ elRef.userData.screenX = (elRef.userData.screenX||window.innerWidth/2) + dx; elRef.userData.screenY = (elRef.userData.screenY||window.innerHeight/2) + dy; updateObjFromScreen(elRef) } });
    window.addEventListener('pointerup', ()=>{ if(dragging){ dragging=false; wrapper.style.cursor='grab'; if(elRef){ const throwZ = Math.min(400, Math.max(-800, elRef.position.z + (-vel.y*2))); gsap.to(elRef.position, {z:throwZ, duration:0.6, ease:"power3.out"}) } } });
    close.addEventListener('click', ()=>{ if(elRef){ scene.remove(elRef); const i = cssObjects.findIndex(x=>x.obj===elRef); if(i>=0) cssObjects.splice(i,1); saveState() } });
    urlBtn.addEventListener('click', ()=>{ const u = prompt('URL„ÇíÂÖ•Âäõ'); if(u && elRef){ elRef.element.querySelector('iframe').src = u; elRef.userData.url = u; saveState() } });
    grab.addEventListener('click', ()=>{ if(elRef){ const dz = (elRef.position.z > 0) ? -300 : 0; gsap.to(elRef.position, {z:dz, duration:0.4, ease:"power2.inOut"}) } });
    let elRef = null;
    return {wrapper, iframe, setRef:(ref)=> elRef=ref};
  }
  function updateObjFromScreen(cssObj){
    const sx = (cssObj.userData.screenX !== undefined) ? cssObj.userData.screenX : window.innerWidth/2;
    const sy = (cssObj.userData.screenY !== undefined) ? cssObj.userData.screenY : window.innerHeight/2;
    const vec = new THREE.Vector3((sx/window.innerWidth)*2-1, -(sy/window.innerHeight)*2+1, 0.5);
    vec.unproject(camera);
    const dir = vec.sub(camera.position).normalize();
    const distance = Math.abs(cssObj.position.z) + 600;
    const pos = camera.position.clone().add(dir.multiplyScalar(distance));
    cssObj.position.copy(pos);
  }
  function createWindow(data){
    const {wrapper,setRef} = makeWindowElement(data);
    const cssObject = new THREE.CSS3DObject(wrapper);
    cssObject.userData = Object.assign({url:data.url||'https://www.youtube.com', alpha:(data.alpha||0.88)}, { screenX: window.innerWidth/2 + (Math.random()*200-100), screenY: window.innerHeight/2 + (Math.random()*120-60) });
    updateObjFromScreen(cssObject);
    cssObject.position.z = data.z || -300 - Math.random()*400;
    scene.add(cssObject);
    setRef(cssObject);
    cssObjects.push({obj:cssObject, el:wrapper});
    wrapper.style.pointerEvents = 'auto';
    wrapper.addEventListener('click', ()=>{ try{ wrapper.querySelector('iframe').focus() }catch(e){} });
    saveState();
    return cssObject;
  }
  function saveState(){
    try{
      const arr = cssObjects.map(x=>{
        const u = x.obj.userData;
        return {url:u.url || x.obj.element.querySelector('iframe').src, screenX:u.screenX, screenY:u.screenY, z:x.obj.position.z, w: parseInt(x.el.style.width||360), h: parseInt(x.el.style.height||220), title: x.el.querySelector('.titleText').textContent, alpha: u.alpha};
      });
      localStorage.setItem(stateKey, JSON.stringify(arr));
    }catch(e){console.warn('save fail', e);}
  }
  function loadState(){
    try{
      const raw = localStorage.getItem(stateKey);
      if(!raw) return;
      const arr = JSON.parse(raw);
      arr.forEach(a=> createWindow(a));
    }catch(e){console.warn('load fail', e);}
  }
  document.getElementById('addWindowBtn').addEventListener('click', ()=>{ createWindow({url:'https://www.youtube.com', alpha: document.getElementById('wndAlpha').value/100});});
  document.getElementById('addBtnUI').addEventListener('click', ()=>{ createWindow({url:'https://www.youtube.com', alpha: document.getElementById('wndAlpha').value/100});});
  document.getElementById('resetBtn').addEventListener('click', ()=>{ if(confirm('ÂÖ®ÈÉ®„É™„Çª„ÉÉ„Éà„Åô„ÇãÔºü')){ localStorage.removeItem(stateKey); location.reload(); }});
  document.getElementById('gearBtn').addEventListener('click', ()=>{ const p=document.getElementById('settingsPanel'); p.style.display = p.style.display==='block' ? 'none' : 'block'; });
  loadState();
  const raycaster = new THREE.Raycaster();
  function render(){ requestAnimationFrame(render); renderer.render(scene,camera); }
  render();
  renderer.domElement.style.pointerEvents = 'auto';
  window.addEventListener('resize', ()=>{ cssObjects.forEach(x=> updateObjFromScreen(x.obj)); });
  const gpCursor = document.getElementById('gpCursor');
  let cursorVisible = false;
  let lastGp = null;
  const gpState = {x: window.innerWidth/2, y: window.innerHeight/2, zIndexAdjust:0};
  function pollGamepads(){
    const gps = navigator.getGamepads ? navigator.getGamepads() : [];
    for(const g of gps){
      if(!g) continue;
      lastGp = g;
      const ax0 = g.axes[0] || 0;
      const ax1 = g.axes[1] || 0;
      const dz = (v)=> Math.abs(v) < 0.12 ? 0 : v;
      const mvX = dz(ax0) * 14;
      const mvY = dz(ax1) * 14;
      if(mvX!==0 || mvY!==0){
        gpState.x = Math.max(0, Math.min(window.innerWidth, gpState.x + mvX));
        gpState.y = Math.max(0, Math.min(window.innerHeight, gpState.y + mvY));
        if(!cursorVisible){ cursorVisible=true; gpCursor.style.display='block'; gpCursor.style.opacity='1'; }
        gpCursor.style.left = gpState.x + 'px';
        gpCursor.style.top = gpState.y + 'px';
        const hits = cssObjects.map(x=>{
          const el = x.el;
          const rect = el.getBoundingClientRect();
          return {obj:x.obj, rect, dist: Math.hypot(gpState.x - (rect.left+rect.width/2), gpState.y - (rect.top+rect.height/2))};
        }).sort((a,b)=>a.dist-b.dist);
        if(hits.length>0 && hits[0].dist < 260){
          const target = hits[0].obj;
          cssObjects.forEach(x=>{ if(x.obj===target) gsap.to(x.obj.position,{z:-80, duration:0.2}); else gsap.to(x.obj.position,{z: -300, duration:0.4});});
        }
      }
      const aBtn = g.buttons[0] && g.buttons[0].pressed;
      const xBtn = g.buttons[2] && g.buttons[2].pressed;
      const plusBtn = g.buttons[9] && g.buttons[9].pressed;
      if(plusBtn){ if(!gpState._plusLock){ createWindow({url:'https://www.youtube.com', alpha: document.getElementById('wndAlpha').value/100}); gpState._plusLock=true; setTimeout(()=>gpState._plusLock=false,400); } }
      if(aBtn){ if(!gpState._aLock){ emulateClick('right'); gpState._aLock=true; setTimeout(()=>gpState._aLock=false,200); } }
      if(xBtn){ if(!gpState._xLock){ emulateClick('left'); gpState._xLock=true; setTimeout(()=>gpState._xLock=false,200); } }
    }
    requestAnimationFrame(pollGamepads);
  }
  requestAnimationFrame(pollGamepads);
  function emulateClick(type){
    const el = document.elementFromPoint(gpState.x, gpState.y);
    if(!el) return;
    const iframe = el.closest('iframe');
    if(iframe){
      try{ iframe.focus(); }catch(e){}
      const rect = iframe.getBoundingClientRect();
      const evt = new MouseEvent(type==='left'?'click':'contextmenu', {clientX: rect.left + rect.width/2, clientY: rect.top + rect.height/2, bubbles:true, cancelable:true});
      iframe.dispatchEvent(evt);
      return;
    }
    const target = el;
    const eventType = type==='left' ? 'click' : 'contextmenu';
    const evt = new MouseEvent(eventType, {clientX: gpState.x, clientY: gpState.y, bubbles:true, cancelable:true});
    target.dispatchEvent(evt);
  }
  window.addEventListener('beforeunload', saveState);
  document.getElementById('wndAlpha').addEventListener('input', (e)=>{
    const v = e.target.value/100;
    cssObjects.forEach(x=>{ x.el.style.background = `rgba(18,18,24,${v})`; x.obj.userData.alpha = v; });
    saveState();
  });
  document.getElementById('shadowToggle').addEventListener('change', (e)=>{
    const on = e.target.checked;
    cssObjects.forEach(x=>{ x.el.style.boxShadow = on ? '0 14px 40px rgba(0,0,0,0.6)' : 'none';});
  });
  function handLoop(){
    if(window.hand && window.hand.enabled){
    }
    requestAnimationFrame(handLoop);
  }
  handLoop();
  setTimeout(()=>{ gsap.to('#hint', {opacity:0.0, duration:1.2, delay:6}); }, 1000);
  document.addEventListener('pointerdown', (e)=>{
    const sp = document.getElementById('settingsPanel');
    if(sp.style.display==='block'){
      if(!sp.contains(e.target) && !document.getElementById('gearBtn').contains(e.target)){
        sp.style.display='none';
      }
    }
  });
  setInterval(saveState, 3000);
})();
</script>
</body>
</html>
