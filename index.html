<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Phone VR Web UI (GH-Pages)</title>
<style>
  :root {
    --ui-bg: rgba(20,24,28,.55);
    --ui-blur: blur(8px);
    --ui-border: rgba(255,255,255,.14);
    --accent: #66ccff; /* 水色 */
  }
  html,body{margin:0;height:100%;background:#000;overflow:hidden;font-family:system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
  /* 背景カメラ */
  #camWrap{position:fixed;inset:0;overflow:hidden}
  #cam{position:absolute;inset:0;width:100%;height:100%;object-fit:cover;transform:scaleX(-1)} /* ミラー表示 */

  /* UIオーバーレイ */
  #ui{position:fixed;inset:0;pointer-events:none}
  .bar{position:fixed;top:0;left:0;right:0;display:flex;gap:.5rem;padding: .6rem .8rem;justify-content:flex-end;pointer-events:auto}
  .btn{background:var(--ui-bg);-webkit-backdrop-filter:var(--ui-blur);backdrop-filter:var(--ui-blur);border:1px solid var(--ui-border);
       color:#fff;border-radius:14px;padding:.5rem .8rem;font-size:14px;cursor:pointer}
  .btn:active{transform:scale(.98)}
  /* ランチャー */
  #dock{position:fixed;left:50%;bottom:2.2rem;transform:translateX(-50%);display:flex;gap:.8rem;pointer-events:auto}
  .tile{width:72px;height:72px;border-radius:18px;border:1px solid var(--ui-border);
        background:var(--ui-bg);-webkit-backdrop-filter:var(--ui-blur);backdrop-filter:var(--ui-blur);
        display:flex;flex-direction:column;align-items:center;justify-content:center;color:#fff;text-decoration:none}
  .tile span{font-size:11px;margin-top:.25rem;opacity:.9}
  /* 時計（右下） */
  #clock{position:fixed;right:.8rem;bottom:.6rem;color:var(--accent);font-weight:600;
         font-size:18px;padding:.35rem .6rem;border-radius:12px;background:rgba(0,0,0,.35);
         border:1px solid var(--ui-border);pointer-events:none}

  /* 設定モーダル */
  #settings{position:fixed;inset:0;display:none;align-items:center;justify-content:center;pointer-events:auto}
  #settings .panel{width:min(92vw,420px);background:var(--ui-bg);-webkit-backdrop-filter:var(--ui-blur);backdrop-filter:var(--ui-blur);
                   border:1px solid var(--ui-border);border-radius:20px;padding:16px;color:#fff}
  .row{display:flex;align-items:center;justify-content:space-between;padding:10px 6px}
  .toggle{inline-size:46px;block-size:26px;border-radius:999px;background:#444;position:relative;cursor:pointer;border:1px solid var(--ui-border)}
  .knob{position:absolute;top:2px;left:2px;inline-size:22px;block-size:22px;border-radius:50%;background:#fff;transition:transform .15s}
  .toggle.on{background:var(--accent)} .toggle.on .knob{transform:translateX(20px)}

  /* カーソル */
  #cursor{position:fixed;left:50%;top:50%;width:20px;height:20px;border:2px solid var(--accent);
          border-radius:50%;transform:translate(-50%,-50%);pointer-events:none;opacity:0;transition:opacity .12s}
  .cursor-dot{position:absolute;left:50%;top:50%;width:4px;height:4px;background:var(--accent);
              border-radius:50%;transform:translate(-50%,-50%)}

  /* スタートオーバーレイ（iOSの権限対策用） */
  #start{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:#000;z-index:20}
  #start button{font-size:18px}
</style>
</head>
<body>
  <div id="camWrap"><video id="cam" playsinline autoplay muted></video></div>

  <div id="ui" aria-hidden="false">
    <div class="bar">
      <button class="btn" id="btnSettings" aria-label="設定">⚙️ 設定</button>
      <button class="btn" id="btnFull" aria-label="フルスクリーン">⛶</button>
    </div>

    <div id="dock" aria-label="アプリランチャー">
      <a class="tile" href="https://m.youtube.com" target="_blank" rel="noopener" data-app="youtube">
        <svg width="30" height="20" viewBox="0 0 30 20" aria-hidden="true"><rect x="0" y="0" width="30" height="20" rx="5" ry="5" fill="none" stroke="white"/></svg>
        <span>YouTube</span>
      </a>
      <a class="tile" href="https://discord.com/app" target="_blank" rel="noopener" data-app="discord">
        <svg width="28" height="20" viewBox="0 0 28 20" aria-hidden="true"><rect x="0" y="0" width="28" height="20" rx="5" ry="5" fill="none" stroke="white"/></svg>
        <span>Discord</span>
      </a>
    </div>

    <div id="clock" role="status">--時:--分</div>
    <div id="cursor"><div class="cursor-dot"></div></div>
  </div>

  <div id="settings">
    <div class="panel">
      <h3 style="margin:4px 6px 10px">設定</h3>
      <div class="row">
        <div>時計を表示</div>
        <div class="toggle" id="tgClock"><div class="knob"></div></div>
      </div>
      <div class="row">
        <div>カーソル感度</div>
        <input id="sens" type="range" min="0.5" max="3" step="0.1" value="1.2" style="width:160px">
      </div>
      <div class="row" style="justify-content:flex-end"><button class="btn" id="closeSettings">閉じる</button></div>
    </div>
  </div>

  <div id="start">
    <button class="btn" id="btnStart">カメラを開始</button>
  </div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const cam = $('#cam');
  const btnStart = $('#btnStart');
  const startOverlay = $('#start');
  const clockEl = $('#clock');
  const tgClock = $('#tgClock');
  const settings = $('#settings');
  const btnSettings = $('#btnSettings');
  const btnFull = $('#btnFull');
  const btnCloseSettings = $('#closeSettings');
  const cursor = $('#cursor');
  const sensInput = $('#sens');

  /* ---- iOS対策：ユーザー操作でgetUserMedia ---- */
  btnStart.addEventListener('click', async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' },
        audio: false
      });
      cam.srcObject = stream;
      startOverlay.style.display = 'none';
    } catch (e) {
      alert('カメラを取得できませんでした: ' + e);
    }
  }, { passive: true });

  /* ---- 時計 ---- */
  function fmtClock(d){
    const h = d.getHours();
    const m = d.getMinutes(); // 例: 23時:8分（ゼロ詰めしない）
    return `${h}時:${m}分`;
  }
  function tick(){
    clockEl.textContent = fmtClock(new Date());
  }
  setInterval(tick, 1000); tick();

  // 表示設定（localStorage）
  const CLOCK_KEY = 'clockEnabled';
  function applyClockVisible(v){
    clockEl.style.display = v ? 'block':'none';
    tgClock.classList.toggle('on', v);
    localStorage.setItem(CLOCK_KEY, v ? '1':'0');
  }
  applyClockVisible(localStorage.getItem(CLOCK_KEY)!=='0');
  tgClock.addEventListener('click', ()=>applyClockVisible(!tgClock.classList.contains('on')));

  /* ---- 設定モーダル ---- */
  btnSettings.addEventListener('click', ()=> settings.style.display='flex');
  btnCloseSettings.addEventListener('click', ()=> settings.style.display='none');

  /* ---- フルスクリーン ---- */
  btnFull.addEventListener('click', async () => {
    try{
      if (!document.fullscreenElement) await document.documentElement.requestFullscreen();
      else await document.exitFullscreen();
    }catch(e){}
  });

  /* ---- コントローラー：Lスティックでカーソル、Aでクリック ---- */
  let cx = window.innerWidth/2, cy = window.innerHeight/2;
  let showUntil = 0;
  let prevBtnA = false;
  let sensitivity = parseFloat(localStorage.getItem('cursorSensitivity')||'1.2') || 1.2;
  sensInput.value = String(sensitivity);
  sensInput.addEventListener('input', ()=>{
    sensitivity = parseFloat(sensInput.value);
    localStorage.setItem('cursorSensitivity', sensitivity);
  });

  function clamp(v, min, max){ return v<min?min:v>max?max:v; }

  function gpLoop(){
    const pads = navigator.getGamepads ? navigator.getGamepads() : [];
    const gp = pads && pads[0];
    if (gp){
      const ax = gp.axes[0] || 0; // 左右
      const ay = gp.axes[1] || 0; // 上下
      const dead = 0.15;
      const vx = Math.abs(ax) > dead ? ax : 0;
      const vy = Math.abs(ay) > dead ? ay : 0;

      if (vx !== 0 || vy !== 0){
        cx = clamp(cx + vx * 10 * sensitivity, 0, window.innerWidth);
        cy = clamp(cy + vy * 10 * sensitivity, 0, window.innerHeight);
        showUntil = performance.now() + 800; // 動かしたら表示
      }
      // Aボタン（標準でindex 0）
      const btnA = !!(gp.buttons[0] && gp.buttons[0].pressed);
      if (btnA && !prevBtnA){
        // カーソル位置の要素をクリック
        const el = document.elementFromPoint(cx, cy);
        if (el){
          // a要素なら click() / それ以外はPointerEvent発火
          if (el instanceof HTMLAnchorElement){
            el.click();
          } else {
            el.dispatchEvent(new MouseEvent('click', {bubbles:true,clientX:cx,clientY:cy}));
          }
        }
        showUntil = performance.now() + 800; // 押したらしばらく表示
      }
      prevBtnA = btnA;
    }
    // カーソル描画
    cursor.style.left = cx+'px';
    cursor.style.top  = cy+'px';
    cursor.style.opacity = performance.now() < showUntil ? '1':'0';

    requestAnimationFrame(gpLoop);
  }
  gpLoop();

  // 画面サイズ更新で範囲調整
  window.addEventListener('resize', ()=>{
    cx = clamp(cx, 0, window.innerWidth);
    cy = clamp(cy, 0, window.innerHeight);
  });

  // タッチでカーソルを一時表示（確認用）
  document.addEventListener('pointermove', (e)=>{
    cx = e.clientX; cy = e.clientY; showUntil = performance.now()+600;
  });

  // PWAっぽくフルスクリーン誘導（任意）
  document.addEventListener('click', ()=>{
    // iOS Chromeは自動FS不可のこと多いので手動ボタン優先
  }, { passive:true });
})();
</script>
</body>
</html>
